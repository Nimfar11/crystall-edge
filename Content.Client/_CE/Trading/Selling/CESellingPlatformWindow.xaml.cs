using System.Linq;
using Content.Client._CE.UserInterface;
using Content.Shared._CE.Trading;
using Content.Shared._CE.Trading.Components;
using Content.Shared._CE.Trading.Prototypes;
using Content.Shared.Power.Components;
using Robust.Client.AutoGenerated;
using Robust.Client.Player;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;
using Robust.Shared.Timing;

namespace Content.Client._CE.Trading.Selling;

[GenerateTypedNameReferences]
public sealed partial class CESellingPlatformWindow : DefaultWindow
{
    [Dependency] private readonly ILogManager _log = default!;
    [Dependency] private readonly IPrototypeManager _proto = default!;
    [Dependency] private readonly IEntityManager _e = default!;
    [Dependency] private readonly IPlayerManager _player = default!;

    private readonly CEClientTradingPlatformSystem _tradingSystem;
    private readonly CEClientEconomySystem _economySystem;
    private Entity<CETradingReputationComponent>? _cachedUser;
    private Entity<CESellingPlatformComponent>? _cachedPlatform;
    private BatteryComponent? _batteryComponent;
    private CESellingPlatformUiState? _cachedState;

    private CETradingFactionPrototype? _selectedFaction;
    public event Action<(ProtoId<CETradingRequestPrototype>, ProtoId<CETradingFactionPrototype>)>? OnRequestSell;
    public event Action? OnSell;

    private ISawmill Sawmill { get; init; }

    public CESellingPlatformWindow()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        Sawmill = _log.GetSawmill("ce_selling");

        _tradingSystem = _e.System<CEClientTradingPlatformSystem>();
        _economySystem = _e.System<CEClientEconomySystem>();

        SellButton.OnPressed += _ => OnSell?.Invoke();
    }

    protected override void FrameUpdate(FrameEventArgs args)
    {
        base.FrameUpdate(args);

        UpdateEnergyBar();
    }

    public void UpdateEnergyBar()
    {
        if (_batteryComponent is null)
        {
            EnergyLabel.Visible = false;
            EnergyProgressBar.Visible = false;
            return;
        }

        EnergyLabel.Visible = true;
        EnergyProgressBar.Visible = true;

        var energyLevel = _batteryComponent.CurrentCharge / _batteryComponent.MaxCharge;
        EnergyLabel.Text = Math.Round(energyLevel * 100) + "%";
        EnergyProgressBar.Value = energyLevel;

        SellButton.Disabled = !(_cachedState is not null &&
                              _cachedPlatform is not null &&
                              _cachedState.Price != 0 &&
                              _batteryComponent.CurrentCharge >= _cachedPlatform.Value.Comp.EnergyCost);
    }

    public void UpdateState(CESellingPlatformUiState state)
    {
        _cachedState = state;
        if (!_e.TryGetComponent<CETradingReputationComponent>(_player.LocalEntity, out var repComp))
            return;

        _cachedUser = (_player.LocalEntity.Value, repComp);

        var plat = _e.GetEntity(state.Platform);
        if (!_e.TryGetComponent<CESellingPlatformComponent>(plat, out var platComp))
            return;

        _cachedPlatform = (plat, platComp);

        //SpriteView
        SpriteView.SetEntity(_cachedPlatform);

        //SellPrice
        SellPriceHolder.RemoveAllChildren();
        SellPriceHolder.AddChild(new CEPriceControl(state.Price));

        if (_cachedUser.Value.Comp.Factions.Count == 0)
            return;

        //Faction tabs update
        TreeTabsContainer.RemoveAllChildren();
        foreach (var faction in _cachedUser.Value.Comp.Factions)
        {
            if (!_proto.TryIndex(faction, out var indexedFaction))
                continue;
            var factionButton = new CETradingFactionButtonControl(
                indexedFaction.Color,
                Loc.GetString(indexedFaction.Name));

            factionButton.OnPressed += () =>
            {
                SelectFaction(indexedFaction);
            };

            TreeTabsContainer.AddChild(factionButton);
        }

        if (_selectedFaction == null)
        {
            var firstFaction = _cachedUser.Value.Comp.Factions.First();
            if (_proto.TryIndex(firstFaction, out var indexedFaction))
                SelectFaction(indexedFaction);
        }
        else if (_selectedFaction != null)
        {
            SelectFaction(_selectedFaction);
        }

        _e.TryGetComponent(_cachedPlatform, out _batteryComponent);
    }

    private void SelectFaction(CETradingFactionPrototype faction)
    {
        if (_cachedPlatform is null)
            return;

        _selectedFaction = faction;
        TreeName.Text = Loc.GetString("ce-trading-faction-request-prefix") + " " + Loc.GetString(faction.Name);

        //Update requests
        Requests.RemoveAllChildren();
        foreach (var request in _tradingSystem.GetRequests(faction))
        {
            var canFullfill = _tradingSystem.CanFulfillRequest(_cachedPlatform.Value, request);
            var requestControl = new CESellingRequestControl(request, canFullfill);

            requestControl.OnSellAttempt += () => OnRequestSell?.Invoke((request, faction));
            Requests.AddChild(requestControl);
        }
    }
}
